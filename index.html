<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
    // دالة التقاط الصورة وتحليلها
    async function scanAndProcess() {
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        // ضبط مقاسات اللقطة بناءً على إطار الفحص
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // بدء عملية التعرف على النص
        try {
            console.log("جاري تحليل الرقم التسلسلي...");
            const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                logger: m => console.log(m) // لمتابعة التقدم في الكونسول
            });

            // إذا وجدنا نصاً طويلاً (رقم تسلسلي محتمل)
            if (text.length > 5) {
                finalizeWarranty(text.trim());
            }
        } catch (error) {
            console.error("خطأ في التحليل البصري:", error);
        }
    }

    function finalizeWarranty(serial) {
        // اهتزاز الهاتف عند النجاح
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        
        // تحديث واجهة الضمان الرقمي بالبيانات الجديدة
        document.getElementById('p-serial').innerText = serial;
        document.getElementById('main-card').innerHTML = `
            <div class="label">تم التوثيق بنجاح</div>
            <div class="p-name">منتج جديد موثق</div>
            <div class="status-box">
                <span class="dot"></span>
                <span>ضمان فعال (Blockchain Secured)</span>
            </div>
        `;
        
        alert("تم التعرف على الرقم: " + serial + "\nتم إصدار الضمان الرقمي!");
        closeCamera();
    }

    // تفعيل المسح التلقائي كل 3 ثوانٍ عند فتح الكاميرا
    let scanInterval;
    function startAutoScan() {
        scanInterval = setInterval(scanAndProcess, 3000);
    }
    
    // تعديل دالة فتح الكاميرا لتشمل المسح التلقائي
    async function openCamera() {
        const cameraLayer = document.getElementById('camera-layer');
        const video = document.getElementById('video');

        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            cameraLayer.style.display = 'flex';
            startAutoScan(); // ابدأ المسح التلقائي
        } catch (err) {
            alert("عذراً، نظام 2026 يتطلب صلاحية الكاميرا.");
        }
    }

    function closeCamera() {
        clearInterval(scanInterval);
        if (stream) stream.getTracks().forEach(track => track.stop());
        document.getElementById('camera-layer').style.display = 'none';
    }
</script>
