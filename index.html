<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BQ2A | TAZO ULTIMATE</title>
    <style>
        :root { --main-bg: #0a0a0c; --neon-blue: #00f2ff; --player-color: #fff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--main-bg); touch-action: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            pointer-events: none; z-index: 100; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            box-sizing: border-box;
        }

        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        
        .player-info {
            background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--neon-blue);
            padding: 8px 15px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 0 10px 10px 0; color: #fff;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.1);
        }

        .badge { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--neon-blue); display: block; }
        .count { font-size: 1.5rem; font-weight: 800; line-height: 1; }

        .game-msg {
            align-self: center; background: rgba(0, 0, 0, 0.6); border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 5px 25px; border-radius: 50px; font-size: 0.9rem;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); margin-top: 10px;
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse { 0% { transform: scale(0.98); opacity: 0.8; } 100% { transform: scale(1.02); opacity: 1; } }

        canvas { position: fixed; top: 0; left: 0; outline: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="player-info">
                <span class="badge">الخصم</span>
                <span class="count" id="enemy-stock">10</span>
            </div>
            <div class="game-msg" id="status-msg">دور الخصم: يضع بطاقته...</div>
            <div class="player-info" style="border-left:none; border-right: 3px solid var(--player-color); border-radius: 10px 0 0 10px; text-align: left;">
                <span class="badge" style="color: var(--player-color);">مخزوني</span>
                <span class="count" id="my-stock">10</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- 1. الإعدادات الأساسية للمحرك ---
        let scene, camera, renderer;
        let playerTazo, enemyTazo;
        let isPlayerTurn = false;
        let playerStock = 10;
        let enemyStock = 10;
        let isDragging = false;
        let dragStartPoint = new THREE.Vector2();
        let hitForce = new THREE.Vector3();
        let animationFrameId; // لتنظيف الـ animation loop

        const tazoRadius = 0.6;
        const tazoThickness = 0.08;

        // وظيفة تهيئة اللعبة
        function initGame() {
            // تنظيف أي عناصر سابقة
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (renderer) renderer.dispose();
            document.querySelectorAll('canvas').forEach(canvas => canvas.remove());

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0c); // خلفية داكنة وجذابة

            // الكاميرا تتكيف مع حجم الشاشة (متجاوبة)
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
            camera.position.set(0, 12, 12);
            camera.lookAt(0, 0, 0);

            // Renderer بجودة عالية وأداء فعال
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // يقلل من الضغط على الجوالات الضعيفة
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; // ظلال ناعمة
            renderer.toneMapping = THREE.ACESFilmicToneMapping; // إضاءة سينمائية
            document.body.appendChild(renderer.domElement);

            // --- 2. إنشاء الطاولة الاحترافية ---
            const tableGeo = new THREE.BoxGeometry(10, 0.5, 15);
            const tableMat = new THREE.MeshStandardMaterial({ 
                color: 0x181008, // لون خشبي داكن
                roughness: 0.6, 
                metalness: 0.1 
            });
            table = new THREE.Mesh(tableGeo, tableMat);
            table.receiveShadow = true;
            scene.add(table);

            // --- 3. الإضاءة المحيطية ---
            const mainLight = new THREE.SpotLight(0xffffff, 2, 30, Math.PI / 4, 0.5, 2);
            mainLight.position.set(0, 15, 0);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 1024;
            mainLight.shadow.mapSize.height = 1024;
            mainLight.target = table;
            scene.add(mainLight);
            scene.add(new THREE.AmbientLight(0xffffff, 0.4)); // ضوء خافت عام

            // --- 4. دالة إنشاء التيزو ---
            function createTazo(color, x, z, isPlayerControlled = false) {
                const group = new THREE.Group();
                const geo = new THREE.CylinderGeometry(tazoRadius, tazoRadius, tazoThickness, 64);
                
                // هنا يمكن تحميل صورة "Echo Echo" كخامة
                const topTexture = new THREE.TextureLoader().load('https://i.ibb.co/L5R9r4s/echo-echo.png'); // رابط صورة Echo Echo
                topTexture.rotation = Math.PI; // تدوير الصورة إذا كانت معكوسة

                const sideMat = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.5, metalness: 0.3 }); // جوانب
                const topMat = new THREE.MeshStandardMaterial({ map: topTexture, roughness: 0.3, metalness: 0.1 }); // وجه البطل
                const bottomMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.6, metalness: 0.1 }); // وجه الشعار

                const materials = [sideMat, topMat, bottomMat];
                const mesh = new THREE.Mesh(geo, materials);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                group.add(mesh);
                
                group.position.set(x, tazoThickness / 2, z); // ارتفاع البطاقة عن الطاولة
                if (!isPlayerControlled) group.rotation.x = Math.PI; // الخصم يضعها مقلوبة (الشعار للأعلى)
                
                scene.add(group);
                return { mesh: group, velocity: new THREE.Vector3(), angularVelocity: new THREE.Vector3(), isPlayer: isPlayerControlled };
            }

            playerTazo = createTazo(0, 5, true); // تيزو اللاعب (أبيض اللون مبدئياً)
            enemyTazo = createTazo(0, 0, false); // تيزو الخصم في المنتصف (مقلوب)

            // --- 5. منطق اللمس (الضربة) ---
            renderer.domElement.addEventListener('touchstart', onTouchStart, false);
            renderer.domElement.addEventListener('touchmove', onTouchMove, false);
            renderer.domElement.addEventListener('touchend', onTouchEnd, false);

            function onTouchStart(event) {
                if (isPlayerTurn && playerTazo) {
                    isDragging = true;
                    dragStartPoint.set(event.touches[0].clientX, event.touches[0].clientY);
                    document.getElementById('status-msg').innerText = "اسحب للإطلاق...";
                }
            }

            function onTouchMove(event) {
                if (isDragging) {
                    const currentPoint = new THREE.Vector2(event.touches[0].clientX, event.touches[0].clientY);
                    const delta = currentPoint.clone().sub(dragStartPoint);
                    // هنا يمكن إضافة مؤشر قوة سحب
                }
            }

            function onTouchEnd(event) {
                if (isDragging) {
                    const endPoint = new THREE.Vector2(event.changedTouches[0].clientX, event.changedTouches[0].clientY);
                    const delta = endPoint.clone().sub(dragStartPoint);
                    
                    // تحويل السحب إلى قوة ثلاثية الأبعاد
                    hitForce.set(delta.x * -0.005, 0, delta.y * -0.005);
                    playerTazo.velocity.add(hitForce);
                    
                    // إضافة دوران (Spin) بسيط عند الضرب
                    playerTazo.angularVelocity.y = delta.x * 0.002;
                    playerTazo.angularVelocity.x = delta.y * 0.001;

                    isDragging = false;
                    isPlayerTurn = false; // ينهي دور اللاعب بعد الضرب
                    document.getElementById('status-msg').innerText = "شاهد الضربة...";
                    setTimeout(endTurn, 3000); // انتظر 3 ثواني لانتهاء الحركة
                }
            }

            // --- 6. حلقة اللعبة والتحديث (Physics & Game Logic) ---
            function animate() {
                animationFrameId = requestAnimationFrame(animate);

                // تحديث حركة التيزو
                [playerTazo, enemyTazo].forEach(tazo => {
                    tazo.mesh.position.add(tazo.velocity);
                    tazo.velocity.multiplyScalar(0.98); // احتكاك يوقف الحركة تدريجياً
                    
                    tazo.mesh.rotation.x += tazo.angularVelocity.x;
                    tazo.mesh.rotation.y += tazo.angularVelocity.y;
                    tazo.angularVelocity.multiplyScalar(0.95); // تباطؤ الدوران
                });

                // فحص التصادم بين التيزو
                const dist = playerTazo.mesh.position.distanceTo(enemyTazo.mesh.position);
                if (dist < tazoRadius * 2) {
                    // منطق تصادم بسيط (للفوز بالبطاقة)
                    const normal = enemyTazo.mesh.position.clone().sub(playerTazo.mesh.position).normalize();
                    const impulse = playerTazo.velocity.clone().sub(enemyTazo.velocity).dot(normal);
                    if (impulse > 0) { // فقط إذا كانت تتجه نحو بعضها
                        playerTazo.velocity.sub(normal.clone().multiplyScalar(impulse * 0.8));
                        enemyTazo.velocity.add(normal.clone().multiplyScalar(impulse * 1.2));
                    }
                }
                
                // فحص قلب البطاقة (Flip Logic)
                const enemyRotationX = enemyTazo.mesh.rotation.x % (2 * Math.PI);
                // تعتبر البطاقة مقلوبة إذا كان دورانها قريب من 0 أو 2 باي (وجه البطل للأعلى)
                enemyTazo.isFlipped = (enemyRotationX > -Math.PI / 2 && enemyRotationX < Math.PI / 2);

                // تحديث واجهة المستخدم
                document.getElementById('enemy-stock').innerText = enemyStock;
                document.getElementById('my-stock').innerText = playerStock;

                renderer.render(scene, camera);
            }

            // --- 7. منطق الأدوار والفوز والخسارة ---
            function startTurn() {
                // إعداد التيزو للدور الجديد
                enemyTazo.mesh.position.set(0, tazoThickness / 2, 0);
                enemyTazo.mesh.rotation.x = Math.PI; // مقلوبة للشعار
                enemyTazo.isFlipped = false;
                enemyTazo.velocity.set(0,0,0);
                enemyTazo.angularVelocity.set(0,0,0);

                playerTazo.mesh.position.set(0, tazoThickness / 2, 5); // بطاقة اللاعب ترجع لمكانها
                playerTazo.velocity.set(0,0,0);
                playerTazo.angularVelocity.set(0,0,0);


                isPlayerTurn = true;
                document.getElementById('status-msg').innerText = "دورك: اضرب التيزو!";
            }

            function endTurn() {
                // فحص هل البطاقة انقلبت
                if (enemyTazo.isFlipped) {
                    document.getElementById('status-msg').innerText = "مبروك! البطاقة لك!";
                    playerStock++;
                    enemyStock--;
                    if (enemyStock <= 0) {
                        document.getElementById('status-msg').innerText = "لقد فزت باللعبة!";
                        // يمكنك إضافة شاشة فوز هنا
                        return;
                    }
                } else {
                    document.getElementById('status-msg').innerText = "لم تنقلب! دور الخصم...";
                }
                
                // بدء دور جديد بعد فترة
                setTimeout(startTurn, 2000);
            }

            // بدء اللعبة
            startTurn();
        }

        // استجابة لتغير حجم الشاشة (متجاوبة)
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });

        initGame(); // تشغيل اللعبة عند تحميل الصفحة
    </script>
</body>
</html>
